```{r setup}
#| message: false
#| warning: false

library(terra)
library(tidyverse)
library(ggcorrplot)
library(ggfortify)
```

## Climate data {.unnumbered}

The climate data was retrieved from [Climatologies at high resolution for the earth's land surface areas (CHELSA; 1981â€“2010 baseline; 1 km resolution)](https://chelsa-climate.org/). We used four bioclimatic variables: mean annual air temperature (bio01), maximum temperature of the warmest month (bio05), minimum temperature of the coldest month (bio06), and annual precipitation (bio12). All layers were resampled to 100 m.

The values of all Bioclimatic variables are then extracted at the location of all terri4sol plots.

```{r extract-chelsa}
#| message: false
#| warning: false
# extract values for all t4s plots
coord_stocks <- read.csv("data/cache/data_stocks.csv") |>
  # project into EPSG:32630
  vect(crs = "epsg:4326") |>
  terra::project("epsg:32630")

climate_data <-
  "data/01_Data/Environmental_variables/CHELSA_bioclim_1981_2010_100m_CI.tif" |>
  rast() |>
  terra::extract(coord_stocks) |>
  select(contains("bio")) |>
  bind_cols(select(as.data.frame(coord_stocks), "site", "plot")) |>
  relocate(site, plot)

write.csv(climate_data, file = "data/cache/climate_data.csv", row.names = FALSE)
```

The following plots have NAs in at least one Bioclim variable.

```{r}
#| message: false
#| warning: false
climate_data |>
  filter(if_any(contains("bio"), is.na)) |>
  relocate(site, plot)
```

Below is the result of a Principal Component Analysis with all bioclimatic variables.

```{r}
#| message: false
#| warning: false
data_pca <- climate_data |>
  filter(!if_any(everything(), is.na))

data_pca |>
  select(contains("bio")) |>
  prcomp(scale = TRUE) |>
  autoplot(
    loadings = TRUE, loadings.label = TRUE,
    data = data_pca, colour = "site"
  ) +
  theme_minimal()
```

We can also plot the pairwise correlation of all climate variables.

```{r}
#| message: false
#| warning: false
climate_data |>
  select(contains("bio")) |>
  drop_na() |>
  cor() |>
  ggcorrplot(type = "upper", lab = TRUE)
```
