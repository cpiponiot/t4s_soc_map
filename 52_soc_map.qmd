```{r setup}
#| message: false
#| warning: false
#| echo: false
#| results: 'hide'
library(tidyverse)
library(terra)
library(quantregForest)
library(data.table)
source("r/qrf_llo.R")
```

# SOC stocks prediction {.unnumbered}

```{r}
#| message: false
#| warning: false
#| eval: false
load("data/cache/models/qrf_final.rda")

path <- "data/01_Data/temp"
# make tiles (to limit memory usage)
dir.create(path)
list.files("data/01_Data/Environmental_variables/", "tif", FALSE, TRUE) |>
  rast() |>
  makeTiles(500, paste0(path, "/tile_.tif"))

# apply to all tiles:
for (fl in list.files(path, "tile", full.names = TRUE)) {
  rm(data_vars)
  gc()
  # get predictors
  n_tile <- strsplit(fl, "_|\\.")[[1]][3]
  data_vars <- rast(fl) |>
    as.data.frame(xy = TRUE) |>
    rename(twi = b1)
  if (nrow(select(drop_na(data_vars), -x, -y)) > 0) {
    # model prediction
    predict.qrf_llo(
      qrf_final,
      parallel = FALSE,
      newdata = select(drop_na(data_vars), -x, -y)
    ) |>
      bind_cols(select(drop_na(data_vars), x, y)) |>
      right_join(select(data_vars, x, y)) |>
      write.csv(paste0(path, "/pred_", n_tile, ".csv"), row.names = FALSE)
  } else {
    select(data_vars, x, y) |>
      mutate(Q10 = NA, Q50 = NA, Q90 = NA) |>
      write.csv(paste0(path, "/pred_", n_tile, ".csv"), row.names = FALSE)
  }
}

# join results
list.files(path, pattern = "pred", full.names = TRUE) |>
  lapply(fread) |>
  rbindlist(use.names = TRUE) |>
  rast() |>
  writeRaster("data/cache/map_pred.tif", overwrite = TRUE)

# remove temporary files
unlink(path, recursive = TRUE)
```

```{r}
#| message: false
#| warning: false
ggplot() +
  geom_spatraster(data = rast("data/cache/map_pred.tif")) +
  facet_wrap(~lyr) +
  scale_fill_viridis_c() +
  coord_equal() +
  theme_minimal()
```
