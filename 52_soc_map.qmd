```{r setup}
#| message: false
#| warning: false
#| echo: false
#| results: 'hide'
library(tidyverse)
library(terra)
library(tidyterra)
library(quantregForest)
library(data.table)
library(future.apply)
source("r/qrf_llo.R")

plan(multisession, workers = detectCores() - 1)
```

# SOC stocks prediction {.unnumbered}

```{r}
#| message: false
#| warning: false
#| eval: false
load("data/cache/models/qrf_final.rda")

path <- "data/01_Data/temp"
# make tiles (to limit memory usage)
dir.create(path)
list.files("data/01_Data/Environmental_variables/", "tif", FALSE, TRUE) |>
  rast() |>
  makeTiles(500, paste0(path, "/tile_.tif"))
# if need to upload on server (with max upload size): use optimised zip files
use_zip <- TRUE
if (use_zip) {
  list.files(path, "\\.tif", full.names = TRUE) |>
    file.size() |>
    optimise_split() |>
    lapply(function(lst) {
      zip(
        zipfile = paste0(path, "/zip_", min(lst), ".zip"),
        files = list.files(path, "\\.tif", full.names = TRUE)[lst],
        mode = "cherry-pick"
      )
    })
}
# apply to all tiles:
done <- paste0(
  "data/01_Data/temp/tile_",
  gsub("pred_|\\.csv", "", list.files(path, "pred")),
  ".tif"
)
all <- list.files(path, ".tif", full.names = TRUE)

future_lapply(setdiff(all, done), function(fl) {
  gc()
  # get predictors
  n_tile <- strsplit(fl, "_|\\.")[[1]][3]
  data_vars <- rast(fl) |>
    as.data.frame(xy = TRUE) |>
    rename(twi = b1)
  if (nrow(select(drop_na(data_vars), -x, -y)) > 0) {
    # model prediction
    predict.qrf_llo(
      qrf_final,
      parallel = FALSE,
      newdata = select(drop_na(data_vars), -x, -y)
    ) |>
      bind_cols(select(drop_na(data_vars), x, y)) |>
      right_join(select(data_vars, x, y)) |>
      write.csv(paste0(path, "/pred_", n_tile, ".csv"), row.names = FALSE)
  } else {
    select(data_vars, x, y) |>
      mutate(Q10 = NA, Q50 = NA, Q90 = NA) |>
      write.csv(paste0(path, "/pred_", n_tile, ".csv"), row.names = FALSE)
  }
})

# join results
list.files(path, pattern = "pred", full.names = TRUE) |>
  lapply(fread) |>
  rbindlist(use.names = TRUE) |>
  rast(crs = "EPSG:32630") |>
  writeRaster("data/cache/map_pred.tif", overwrite = TRUE)

# remove temporary files
unlink(path, recursive = TRUE)
```

```{r}
#| message: false
#| warning: false
#| fig.height: 6
#| fig.width: 12
ggplot() +
  geom_spatraster(data = rast("data/cache/map_pred.tif")) +
  facet_wrap(~lyr) +
  scale_fill_viridis_c(na.value = "transparent") +
  theme_minimal()
```
